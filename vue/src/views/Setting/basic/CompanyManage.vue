<template>
   <div class="content">
      <div class="container-fluid">
         <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
               <h4 class="card-title">Í∞úÏù∏Ï†ïÎ≥¥ ÏÑ§Ï†ï</h4>
               <div class="button-group">
                  <button class="btn btn-secondary btn-fill mr-1" @click="btnMemberReset">Ï¥àÍ∏∞Ìôî</button>
                  <button class="btn btn-primary btn-fill mr-1" @click="btnMemberSave">Ï†ÄÏû•</button>
               </div>
            </div>
         </div>

         <div class="row">
            <div class="col-12">
               <div class="card">
                  <div class="card-body">
                     <div class="section">
                        <div class="section-header">[ ÌöåÏÇ¨Ï†ïÎ≥¥ ]</div>
                        <div class="row p-1">
                           <div class="col-md-3">
                              <label>ÌöåÏÇ¨Î™Ö <i class="fa-solid fa-asterisk"></i></label>
                              <input type="text" v-model="viewData.compNm" class="form-control readonly" />
                           </div>
                           <div class="col-md-3">
                              <label>ÏÇ¨ÏóÖÏûêÎì±Î°ùÎ≤àÌò∏ <i class="fa-solid fa-asterisk"></i></label>
                              <input type="text" v-model="viewData.businessNo" class="form-control readonly" />
                           </div>
                           <div class="col-md-3">
                              <label>ÎåÄÌëúÏûê</label>
                              <input type="text" v-model="viewData.ceoNm" class="form-control readonly" />
                           </div>
                        </div>
                     </div>

                     <div class="section">
                        <div class="section-header">[ Í∏∞Î≥∏Ï†ïÎ≥¥ ]</div>
                        <div class="row p-1">
                           <div class="col-md-3">
                              <label>ÎåÄÌëúÏ†ÑÌôî <i class="fa-solid fa-asterisk"></i></label>
                              <input type="text" v-model="viewData.mberId" class="form-control readonly" />
                           </div>
                           <div class="col-md-3">
                              <label>Ïù¥Î©îÏùº <i class="fa-solid fa-asterisk"></i></label>
                              <input type="text" v-model="viewData.esntlId" class="form-control readonly" />
                           </div>
                           <div class="col-md-3">
                              <label>Ìå©Ïä§ <i class="fa-solid fa-asterisk"></i></label>
                              <input type="text" v-model="formData.mberNm" class="form-control editable" />
                           </div>
                        </div>

                     </div>

                     <div class="section">
                        <div class="section-header">[ ÏÑ§Ï†ï ]</div>
                        <div class="row p-1">
                           <div class="col-md-1">
                              <label>Ïö∞Ìé∏Î≤àÌò∏ <i class="fa-solid fa-asterisk"></i></label>
                              <input type="text" v-model="viewData.mberId" class="form-control editable" />
                           </div>
                           <div class="col-md-5">
                              <label>Ï£ºÏÜå <i class="fa-solid fa-asterisk"></i></label>
                              <input type="text" v-model="viewData.esntlId" class="form-control editable" />
                           </div>
                           <div class="col-md-5">
                              <label>ÏÉÅÏÑ∏Ï£ºÏÜå <i class="fa-solid fa-asterisk"></i></label>
                              <input type="text" v-model="formData.mberNm" class="form-control editable" />
                           </div>
                        </div>

                     </div>

                     <div class="section">
                        <div class="section-header">[ ÏÑ§Ï†ï ]</div>
                        <div class="row p-1">
                           <div class="col-md-6">
                              <label class="align-items-center">Î©îÎâ¥ÏÇ¨Ïö© <i class="fa-solid fa-asterisk"></i></label>
                              <input type="email" v-model="formData.mberEmailAdres" class="editable" />
                           </div>
                           <div class="col-md-3">
                              <label class="align-items-center">Í∑ºÎ¨¥ ÏãúÏûëÏãúÍ∞Ñ <i class="fa-solid fa-asterisk"></i></label>
                              <input type="email" v-model="formData.mberEmailAdres" class="editable" />
                           </div>
                           <div class="col-md-3">
                              <label class="align-items-center">Í∑ºÎ¨¥ Ï¢ÖÎ£åÏãúÍ∞Ñ <i class="fa-solid fa-asterisk"></i></label>
                              <input type="email" v-model="formData.mberEmailAdres" class="editable" />
                           </div>
                        </div>
                     </div>

                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>

</template>

<script setup>
   import { onBeforeMount, ref } from 'vue';
   import axios from '../../../assets/js/customAxios';
   import Swal from 'sweetalert2';

   //============================= Í≥µÌÜµÏΩîÎìú Ìï®Ïàò =============================
   import { getComm } from '../../../assets/js/common'

   // üìå Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•Ïö©
   const formData = ref({
      mberNm: "",
      mberEmailAdres: "",
      areaNo: "",
      middleTelno: "",
      endTelno: "",
      mbtlnum: ""
   });

   const originalData = ref({});  // ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (ÏàòÏ†ï ÎπÑÍµêÏö©)

   // üìå ÏùΩÍ∏∞ Ï†ÑÏö© Îç∞Ïù¥ÌÑ∞ (ÌôîÎ©¥ ÌëúÏãúÏö©)
   const viewData = ref({
      deptNm: "",
      gradeNm: "",
      respNm: "",
      mberId: "",
      esntlId: "",
   });

   // üìå Í≥µÌÜµÏΩîÎìú Î™©Î°ù (ÏßÄÏó≠Î≤àÌò∏)
   const commCodeList = ref([]);

   // ============================================= Lifecycle =============================================
   // Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
   onBeforeMount(async () => {
      await memberGet();       // ÌöåÏõê Ï†ïÎ≥¥ Ï°∞Ìöå
      await commonCodeList();  // Í≥µÌÜµÏΩîÎìú Ï°∞Ìöå
      setSelectedAreaNo();     // ÏßÄÏó≠Î≤àÌò∏ ÎîîÌè¥Ìä∏ ÏÑ∏ÌåÖ
   });

   // ============================================= Btn Event =============================================
   // Ï¥àÍ∏∞Ìôî Î≤ÑÌäº Ïù¥Î≤§Ìä∏
   const btnMemberReset = () => {
      formData.value = JSON.parse(JSON.stringify(originalData.value)); // ÍπäÏùÄ Î≥µÏÇ¨Î°ú Ï¥àÍ∏∞Ìôî
      Swal.fire({
         icon: "info",
         title: "Ï¥àÍ∏∞Ìôî ÏôÑÎ£å",
      });
   };

   // Ï†ÄÏû• Î≤ÑÌäº Ïù¥Î≤§Ìä∏
   const btnMemberSave = () => {
      const modifiedData = getModifiedFields(originalData.value, formData.value);

      if (!validateFormData()) {
        return;  // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ Ïã§Ìå® Ïãú Ï§ëÎã®
      }

      if (Object.keys(modifiedData).length === 0) {
         Swal.fire({
            icon: "info",
            title: "ÏàòÏ†ïÎêú Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§."
         });
         return;
      }

      Swal.fire({
         title: `${formData.value.mberNm}ÎãòÏùò Ï†ïÎ≥¥Î•º ÏàòÏ†ïÌïòÏãúÍ≤†ÏäµÎãàÍπå?`,
         icon: "question",
         showCancelButton: true,
         customClass: {
            confirmButton: "btn btn-secondary btn-fill",
            cancelButton: "btn btn-primary btn-fill",
         },
         confirmButtonText: "Ï∑®ÏÜå",
         cancelButtonText: "ÌôïÏù∏"
      }).then((result) => {
         if (result.dismiss == Swal.DismissReason.cancel) {
            // ÌöåÏõêÏ†ïÎ≥¥ ÏàòÏ†ï
            memberModify(formData.value);

            Swal.fire({
               icon: "success",
               title: "ÏàòÏ†ï ÏôÑÎ£å",
               text: "ÌöåÏõê Ï†ïÎ≥¥Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§."
            });
         }
      });
   };

   // ============================================= Axios Event =============================================
   // ÌöåÏõê Ï†ïÎ≥¥ Ï°∞Ìöå
   const memberGet = async () => {
      try {
         const result = await axios.get('/api/member/info');
         const data = result.data;

         // ÏùΩÍ∏∞Ï†ÑÏö© Îç∞Ïù¥ÌÑ∞
         viewData.value = {
            deptNm: data.deptNm || "",
            gradeNm: data.gradeNm || "",
            respNm: data.respNm || "",
            mberId: data.mberId || "",
            esntlId: data.esntlId || "",
         };

         // ÏàòÏ†ï Í∞ÄÎä• Îç∞Ïù¥ÌÑ∞
         formData.value = {
            mberNm: data.mberNm || "",
            mberEmailAdres: data.mberEmailAdres || "",
            areaNo: data.areaNo || "",
            middleTelno: data.middleTelno || "",
            endTelno: data.endTelno || "",
            mbtlnum: data.mbtlnum?.trim() || ""
         };

         // ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (ÏàòÏ†ï ÎπÑÍµêÏö©)
         originalData.value = JSON.parse(JSON.stringify(formData.value));
      } catch (err) {
         Swal.fire({
            icon: "error",
            title: "ÌöåÏõê Ï†ïÎ≥¥ Ï°∞Ìöå Ïã§Ìå®",
            text: err.response?.data?.error || err.message
         });
      }
   };

   // ÌöåÏõê Ï†ïÎ≥¥ ÏàòÏ†ï (Ïù¥Î¶Ñ/Ïù¥Î©îÏùº/Ï†ÑÌôî/Ìú¥ÎåÄÌè∞Îßå Ï†ÑÏÜ°)
   const memberModify = async (modifiedData) => {
      try {

         await axios.put('/api/member', modifiedData, {
               headers: { 'Content-Type': 'application/json' }
         });

         // Ï†ÄÏû• ÏÑ±Í≥µ ÌõÑ ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ Í∞±Ïã†
         originalData.value = JSON.parse(JSON.stringify(formData.value));
      } catch (err) {
         Swal.fire({
            icon: "error",
            title: "ÏàòÏ†ï Ïã§Ìå®",
            text: err.response?.data?.error || err.message
         });
      }
   };

   // Í≥µÌÜµÏΩîÎìú Ï°∞Ìöå Ìï®Ïàò (ÏßÄÏó≠Î≤àÌò∏Ïö©)
   const commonCodeList = async () => {
      commCodeList.value = await getComm("LC");
   };

   // Í≥µÌÜµÏΩîÎìúÏôÄ DB Í∞í ÏùºÏπò Ï≤òÎ¶¨
   const setSelectedAreaNo = () => {
      const selectedArea = commCodeList.value.find(comm => comm.commDtlCd === formData.value.areaNo);
      if (selectedArea) {
         formData.value.areaNo = selectedArea.commDtlCd;
      }
   };

   // Î≥ÄÍ≤ΩÎêú ÌïÑÎìúÎßå Ï∂îÏ∂úÌïòÎäî Ïú†Ìã∏ Ìï®Ïàò
   const getModifiedFields = (original, current) => {
      const modified = {};
      Object.keys(current).forEach(key => {
         if (original[key] !== current[key]) {
            modified[key] = current[key];
         }
      });
      return modified;
   };

   const validateFormData = () => {
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;   // Ïù¥Î©îÏùº ÌòïÏãù Ï≤¥ÌÅ¨
      const phonePattern = /^[0-9]*$/;                     // Ïà´ÏûêÎßå ÌóàÏö© (Ï†ÑÌôîÎ≤àÌò∏)

      if (!formData.value.mberNm?.trim()) {
         Swal.fire({
            icon: "info",
            title: "Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.",
         });
         return false;
      }

      if (!formData.value.mberEmailAdres?.trim()) {
         Swal.fire({
            icon: "info",
            title: "Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.",
         });
         return false;
      }

      if (!emailPattern.test(formData.value.mberEmailAdres)) {
         Swal.fire({
            icon: "info",
            title: "Ïù¥Î©îÏùº ÌòïÏãùÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.",
         });
         return false;
      }

      if (!formData.value.middleTelno || formData.value.middleTelno.length > 5) {
         Swal.fire({
            icon: "info",
            title: "Ï†ÑÌôîÎ≤àÌò∏Îäî 4ÏûêÎ¶¨Î°ú Ïù¥ÌïòÎ°ú ÏûÖÎ†•ÌïòÏÑ∏Ïöî.",
         });
         return false;
      }

      if (!formData.value.endTelno || formData.value.endTelno.length > 5) {
         Swal.fire({
            icon: "info",
            title: "Ï†ÑÌôîÎ≤àÌò∏Îäî 4ÏûêÎ¶¨ Ïù¥ÌïòÎ°ú ÏûÖÎ†•ÌïòÏÑ∏Ïöî.",
         });
         return false;
      }

      if (formData.value.middleTelNo && !phonePattern.test(formData.value.middleTelNo)) {
         Swal.fire({
            icon: "info",
            title: "Ï†ÑÌôîÎ≤àÌò∏Îäî Ïà´ÏûêÎßå ÏûÖÎ†• Í∞ÄÎä•Ìï©ÎãàÎã§.",
         });
         return false;
      }

      if (formData.value.endTelno && !phonePattern.test(formData.value.endTelno)) {
         Swal.fire({
            icon: "info",
            title: "Ï†ÑÌôîÎ≤àÌò∏Îäî Ïà´ÏûêÎßå ÏûÖÎ†• Í∞ÄÎä•Ìï©ÎãàÎã§.",
         });
         return false;
      }

      return true; // ÌÜµÍ≥º
   };
</script>

<style lang="scss" scoped>
   .section {
      margin-bottom: 70px;
   }

   .section-header {
      font-weight: bold;
      font-size: 15px;
      margin-bottom: 20px;
      border-bottom: 1.5px solid #002966;
      padding-bottom: 10px;
      color: #636363;
   }

   .form-group:last-child {
      margin-right: 0;
   }

   input, select {
      width: 100%;
      padding: 8px;
      border: none;
      border-bottom: 0.5px solid #7c7c7c;
      border-radius: 3px;
   }

   .readonly {
      background-color: #fff;
      color: #7c7c7c;
      cursor: not-allowed;  /* ÎßàÏö∞Ïä§ Ïò¨Î¶¨Î©¥ Í∏àÏßÄ ÌëúÏãú */
      pointer-events: none; /* ÌÅ¥Î¶≠, Ìè¨Ïª§Ïä§ ÎßâÍ∏∞ */
      user-select: none;    /* ÎìúÎûòÍ∑∏Î°ú ÌÖçÏä§Ìä∏ ÏÑ†ÌÉù ÎßâÍ∏∞ */
   }


   .editable {
      background: #eee;
   }

   .button-group {
      display: flex;
      justify-content: center;
      align-items: center;
   }

   .phone-group {
      display: flex;
      align-items: center;
      gap: 5px; /* Í∞Å ÏûÖÎ†•Ïπ∏ ÏÇ¨Ïù¥ Ïó¨Î∞± */

      select:nth-of-type(1) {
         width: 20%;
      }

      input:nth-of-type(1),
      input:nth-of-type(2){
         -webkit-appearance: none;
         width: 30%;
      }

      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
         -webkit-appearance: none;
         margin: 0;
      }
   }

   .phone-group span {
      font-weight: bold;
   }
</style>
