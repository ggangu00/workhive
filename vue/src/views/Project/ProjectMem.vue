<template>
    <div class="content">
        <div class="container-fluid">
            <card>
                <h4 class="card-title float-left">ÌîÑÎ°úÏ†ùÌä∏ Ï∞∏Ïó¨ÏûêÍ¥ÄÎ¶¨</h4>
            </card>

            <div class="row">
                <div class="col-7">
                    <card>
                        <div class="row m-0">
                            <!-- Ìä∏Î¶¨ Î∑∞ (ÏôºÏ™Ω) -->
                            <div class="alert alert-primary">
                                <span>
                                    <i class="fa-solid fa-circle-info" aria-hidden="true"></i>
                                    Ï∂îÍ∞ÄÌï† Íµ¨ÏÑ±ÏõêÏùÑ ÏÑ†ÌÉùÌïòÏó¨ Î∞∞Ï†ïÌï† ÌîÑÎ°úÏ†ùÌä∏Î°ú ÎìúÎûòÍ∑∏Ìï¥Ï£ºÏÑ∏Ïöî
                                </span>
                            </div>
                            <div class="col-3 depth treeview"><!-- Ï°∞ÏßÅ Ìä∏Î¶¨ -->
                                <ul class="list-unstyled">
                                    <li><i class="fa-solid fa-angle-down"></i> Í∞úÎ∞úÌåÄ (137)</li>
                                    <li class="ms-3"><i class="fa-solid fa-angle-right" aria-hidden="true"></i> Í∞úÎ∞ú 1ÌåÄ
                                        (10)
                                    </li>
                                    <li class="ms-3"><i class="fa-solid fa-angle-right" aria-hidden="true"></i> Í∞úÎ∞ú 2ÌåÄ
                                        (12)
                                    </li>
                                    <li class="ms-3 mb-1"><i class="fa-solid fa-angle-right" aria-hidden="true"></i> Í∞úÎ∞ú
                                        3ÌåÄ
                                        (15)</li>
                                    <li><i class="fa-solid fa-angle-down" aria-hidden="true"></i> ÎîîÏûêÏù∏ÌåÄ (13)</li>
                                    <li class="ms-3"><i class="fa-solid fa-angle-right" aria-hidden="true"></i> ÎîîÏûêÏù∏ 1ÌåÄ
                                        (5)
                                    </li>
                                    <li class="ms-3"><i class="fa-solid fa-angle-right" aria-hidden="true"></i> ÎîîÏûêÏù∏ 2ÌåÄ
                                        (6)
                                    </li>
                                    <li class="ms-3 mb-1"><i class="fa-solid fa-angle-right" aria-hidden="true"></i> ÎîîÏûêÏù∏
                                        3ÌåÄ
                                        (2)</li>
                                    <li class="mb-1"><i class="fa-solid fa-angle-right" aria-hidden="true"></i> Ïù∏ÏÇ¨ÌåÄ (6)
                                    </li>
                                    <li><i class="fa-solid fa-angle-right" aria-hidden="true"></i> Í∏∞ÌöçÌåÄ (9)</li>
                                </ul>
                            </div>

                            <!-- Íµ¨ÏÑ±Ïõê ÌÖåÏù¥Î∏î (Ïò§Î•∏Ï™Ω) -->
                            <div class="col-9 m-group">
                                <div class="d-flex p-2 mb-1">
                                    <div class="d-flex" style="align-items: center;">
                                        <select name="searchSel" id="searchSel" class="form-select w50">
                                            <option value="name">Ïù¥Î¶Ñ</option>
                                            <option value="auth">ÏÇ¨Î≤à</option>
                                        </select>
                                        <input type="text" class="form-control" placeholder="Í≤ÄÏÉâÏñ¥ ÏûÖÎ†•" />
                                        <button class="btn btn-info btn-fill w30">Í≤ÄÏÉâ</button>
                                    </div>
                                </div>

                                <table class="table m-table">
                                    <colgroup>
                                        <col width="10%">
                                        <col width="20%">
                                        <col width="20%">
                                        <col width="30%">
                                    </colgroup>
                                    <thead class="table-light">
                                        <tr>
                                            <th>Î≤àÌò∏</th>
                                            <th>Ïù¥Î¶Ñ</th>
                                            <th>ÏßÅÍ∏â</th>
                                            <th>ÏßÑÌñâ Ï§ëÏù∏ ÌîÑÎ°úÏ†ùÌä∏ Í∞úÏàò</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        <tr v-for="(member, i) in members" :key="i">
                                            <td>{{ i + 1 }}</td>
                                            <td>
                                                <div class="profile-text" align="left">
                                                    <span class="team-label" style="text-align:left">{{ member.deptNm
                                                        }}</span>
                                                    <span class="user-name">{{ member.mberNm }} ({{ member.mberId
                                                        }})</span>
                                                </div>
                                            </td>
                                            <td>{{ member.gradeNm }}</td>
                                            <td>{{ member.projectCnt }}Í±¥</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </card>
                </div>

                <div class="col-5">
                    <card>
                        <div class="m-0">
                            <!-- Ìä∏Î¶¨ Î∑∞ (ÏôºÏ™Ω) -->
                            <div class="d-flex justify-content-between align-items-center p-2 mb-1">
                                <div class="d-flex" style="align-items: center;">
                                    <label class="w50">ÌîÑÎ°úÏ†ùÌä∏Î™Ö</label>
                                    <input type="text" class="form-control" placeholder="Í≤ÄÏÉâÏñ¥ ÏûÖÎ†•" />
                                </div>
                            </div>

                            <div class="project treeview">
                                <!-- ÌîÑÎ°úÏ†ùÌä∏ Ìä∏Î¶¨ -->
                                <ul class="list-unstyled" v-for="project in projectList" :key="project"
                                    @click="project.memberArr.length > 0 ? toggleMemMenu(project) : ''"
                                    style="cursor: pointer;">
                                    <span>
                                        <i :class="['folder', project.isHidden ? 'bi bi-folder-minus' : 'bi bi-folder-plus',
                                            project.memberArr.length < 1 ? 'bi bi-folder' : '']"></i>
                                        {{ project.prNm }} ({{ project.memberArr.length }})
                                    </span>

                                    <li v-for="member in project.memberArr" :key="member" class="ms-3"
                                        v-show="project.isHidden">
                                        <span>
                                            <i class="bi bi-dot"></i>
                                            {{ member.deptNm != null ? '[' + member.deptNm + ']' : '' }}
                                            {{ member.mberNm || '' }}
                                            {{ member.gradeNm || '' }}
                                            <i class="bi bi-x" @click="btnProjectMemRemove(member)"></i>
                                            <i class="fa-solid fa-crown master mlp5" aria-hidden="true"
                                                v-show="member.mgrSt == 'A01'"></i>
                                        </span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </card>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- ÏõêÎ≥∏ Î¶¨Ïä§Ìä∏ -->
        <div class="list">
            <h3>ÏõêÎ≥∏ Î¶¨Ïä§Ìä∏</h3>
            <VueDraggableNext v-model="sourceItems" group="shared" item-key="id" @start="dragging = true"
                @end="dragging = false" @choose="onChoose" @unchoose="onUnchoose" :move="onMove"
                class="draggable-container">
                <template #item="{ element }">
                    <div :class="['draggable-item', { selected: selectedItems.includes(element.id) }]"
                        @click="toggleSelection(element.id, $event)">
                        {{ element.name }}
                    </div>
                </template>
            </VueDraggableNext>
        </div>

        <!-- ÌÉÄÍ≤ü Î¶¨Ïä§Ìä∏ -->
        <div class="list">
            <h3>ÌÉÄÍ≤ü Î¶¨Ïä§Ìä∏</h3>
            <VueDraggableNext v-model="targetItems" group="shared" item-key="id" class="draggable-container">
                <template #item="{ element }">
                    <div class="draggable-item">
                        {{ element.name }}
                    </div>
                </template>
            </VueDraggableNext>
        </div>
    </div>

</template>

<script setup>
import { onBeforeMount, ref, defineComponent } from 'vue';
import axios from "../../assets/js/customAxios.js";

//========================== Ïª¥Ìè¨ÎÑåÌä∏ ==========================
import Swal from 'sweetalert2';
import { VueDraggableNext } from 'vue-draggable-next'
import Card from '../../components/Cards/Card.vue'

defineComponent({
    components: { VueDraggableNext }
});

onBeforeMount(() => {
    memberGetList();
    projectGetList();
});

const toggleMemMenu = (memberMenu) => {
    memberMenu.isHidden = !memberMenu.isHidden;
};

//========================== drag ==========================
const sourceItems = ref([
    { id: 1, name: "üçé ÏÇ¨Í≥º" },
    { id: 2, name: "üçå Î∞îÎÇòÎÇò" },
    { id: 3, name: "üçá Ìè¨ÎèÑ" },
    { id: 4, name: "üçä Ïò§Î†åÏßÄ" },
    { id: 5, name: "üçâ ÏàòÎ∞ï" }
]);

const targetItems = ref([]);
const selectedItems = ref([]);
const dragging = ref(false);

// ÏïÑÏù¥ÌÖú ÏÑ†ÌÉù/Ìï¥Ï†ú (Ctrl/Command ÌÇ§ Ï≤¥ÌÅ¨)
const toggleSelection = (id, event) => {
    if (event.ctrlKey || event.metaKey) {
        if (selectedItems.value.includes(id)) {
            selectedItems.value = selectedItems.value.filter(item => item !== id);
        } else {
            selectedItems.value.push(id);
        }
    } else {
        selectedItems.value = [id]; // Îã®Ïùº ÏÑ†ÌÉù
    }
};

// ÎìúÎûòÍ∑∏ Ïãú ÏÑ†ÌÉùÎêú ÏïÑÏù¥ÌÖúÎßå Ïù¥ÎèôÌïòÎèÑÎ°ù ÌïÑÌÑ∞
const onMove = (event) => {
    if (selectedItems.value.length > 0) {
        return selectedItems.value.includes(event.draggedContext.element.id);
    }
    return true;
};

// ÎìúÎûòÍ∑∏ ÏãúÏûë Ïãú ÏÑ†ÌÉùÎêú ÏöîÏÜå Ïú†ÏßÄ
const onChoose = (event) => {
    if (!selectedItems.value.includes(event.item.__draggable_context.element.id)) {
        selectedItems.value = [event.item.__draggable_context.element.id];
    }
};

// ÎìúÎûòÍ∑∏Í∞Ä ÎÅùÎÇú ÌõÑ ÏÑ†ÌÉù Î™©Î°ù Ï¥àÍ∏∞Ìôî
const onUnchoose = () => {
    selectedItems.value = [];
};


//======================= axios =======================

//Íµ¨ÏÑ±Ïõê Ï†ÑÏ≤¥Ï°∞Ìöå
const members = ref([]);
const memberGetList = async () => {

    try {
        const result = await axios.get(`/api/member`);
        members.value = result.data;

    } catch (err) {
        members.value = [];

        Swal.fire({
            icon: "error",
            title: "API Ï°∞Ìöå Ïò§Î•ò",
            text: "Error : " + err
        });
    }
}

//ÏßÑÌñâÏ§ëÏù∏ ÌîÑÎ°úÏ†ùÌä∏ Ï†ÑÏ≤¥Ï°∞Ìöå
const projectList = ref([]);
const projectGetList = async () => {

    try {
        const result = await axios.get('/api/project/tree');
        projectList.value = result.data;

        menuBuildTree(projectList);
    } catch (err) {
        projectList.value = [];

        Swal.fire({
            icon: "error",
            title: "API Ï°∞Ìöå Ïò§Î•ò",
            text: "Error : " + err
        });
    }
}

// ÌîÑÎ°úÏ†ùÌä∏ Ìä∏Î¶¨ Íµ¨Ï°∞ ÏÉùÏÑ±
const menuBuildTree = (projectList) => {

    let projectArr = new Map();
    let memberArr = new Map();

    projectList.value.forEach(project => {

        if (project.parent == 1) {
            projectArr.set(project.prCd, {
                prNm: project.prNm,
                parent: project.parent,
                iconClass: 'bi bi-folder-plus',
                memberArr: [],
            });
        }
    });


    projectList.value.forEach(project => {

        if (project.parent == 0 && project.mberId) {
            const parentMenu = projectArr.get(project.prCd); // mainMenusÏùò keyÍ∞íÏúºÎ°ú valueÎ•º Í∞ÄÏ†∏Ïò¥

            if (parentMenu) {
                // parentMenuÏùò memberArrÏóê Î∞∞Ïó¥ ÎÑ£Í∏∞
                parentMenu.memberArr.push({
                    prCd: project.prCd,
                    prNm: project.prNm,
                    mberId: project.mberId,
                    mberNm: project.mberNm,
                    deptNm: project.deptNm,
                    gradeNm: project.gradeNm,
                    mgrSt: project.mgrSt,
                    iconClass: 'fa-solid fa-angle-right'
                });
                memberArr.set(project.prCd, parentMenu.memberArr[parentMenu.memberArr.length - 1]); // Ï†ÄÏû•
            }
        }
    });

    projectList.value = Array.from(projectArr, ([key, value]) => ({
        prCd: key,
        ...value,
    }));
}

// ÌîÑÎ°úÏ†ùÌä∏ Ï∞∏Ïó¨Ïûê ÏÇ≠Ï†ú Î≤ÑÌäº
const btnProjectMemRemove = (param) => {
    console.log(param);
    Swal.fire({
        title: "Ìï¥Îãπ Ï∞∏Ïó¨ÏûêÎ•º ÌîÑÎ°úÏ†ùÌä∏ÏóêÏÑú Ï†úÏô∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?",
        icon: "question",
        showCancelButton: true,
        customClass: {
            confirmButton: "btn btn-secondary btn-fill",
            cancelButton: "btn btn-danger btn-fill"
        },
        confirmButtonText: "Îã´Í∏∞",
        cancelButtonText: "ÏÇ≠Ï†ú",
    }).then((result) => {
        if (result.dismiss == Swal.DismissReason.cancel) {
            ProjectMemRemove(param); //ÏÇ≠Ï†úÏ≤òÎ¶¨ Ìï®Ïàò
        }
    });
}

//ÌîÑÎ°úÏ†ùÌä∏ Ï∞∏Ïó¨Ïûê ÏÇ≠Ï†ú
const ProjectMemRemove = async (param) => {

    try {
        const response = await axios.delete(`/api/project/tree/delete`, {
            params: {
                prCd: param.prCd,
                mberId: param.mberId
            }
        });

        if (response.data === true) {
            Swal.fire({
                icon: "success",
                title: "ÏÇ≠Ï†úÏôÑÎ£å",
                text: "ÏÑ†ÌÉùÌïú Ï∞∏Ïó¨ÏûêÎ•º ÏÇ≠Ï†úÌïòÏòÄÏäµÎãàÎã§",
            })
        }
    } catch (err) {
        Swal.fire({
            icon: "error",
            title: "ÏÇ≠Ï†ú Ïã§Ìå®",
            text: "Error : " + err
        });
    }
}

</script>