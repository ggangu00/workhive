<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="egovframework.com.approval.mapper.DocumentMapper">
	
	<!-- 문서기안 -->
    <insert id="documentInsert" parameterType="egovframework.com.approval.service.Document" useGeneratedKeys="true" keyProperty="docCd">
       INSERT INTO DOCUMENT (
	       DOC_CD, 
	       DOC_TITLE, 
	       DOC_CN_EDITOR, 
	       MBER_ID, 
	       DRAFT_DT, 
	       COMPLETE_DT, 
	       DOC_KIND, 
	       ATCH_FILE_ID, 
	       FORM_CD)
       VALUES (
	       'DOC' || seq_document_cd.NEXTVAL, 
	       #{docTitle},  
	       #{docCnEditor}, 
	       #{mberId}, 
	       SYSDATE, 
	       #{completeDt},
	       #{docKind}, 
		   #{atchFileId}, 
		   #{formCd}
		   )
    </insert>
    
    <!-- 문서 등록 후 문서코드가져오기 -->
    <select id="lastDocCdGet" resultType="String">
	    SELECT 'DOC' || seq_document_cd.CURRVAL FROM dual
	</select>
    
    <!-- 결재선등록 -->
    <insert id="approvalInsert" parameterType="egovframework.com.approval.service.ApprovalLine">
    	INSERT INTO APPROVAL_LINE (doc_cd, mber_id, sign_seq, sign_opn, sign_dt, sign_name)
    	VALUES (#{docCd}, #{mberId}, #{signSeq}, #{signOpn}, sysdate, #{signName})
    </insert>
    <!-- 수신정보 등록 -->
	  <insert id="receptionInsert" parameterType="egovframework.com.approval.service.Reception">
    	INSERT INTO RECEPTION (recept_cd, recept_yn, doc_cd, mber_id, dept_cd)
    	VALUES ('RCPTN' || seq_reception_cd.NEXTVAL, #{receptYn}, #{docCd}, #{mberId}, #{deptCd})
    </insert>
    
    <!-- 파일등록 -->
    <insert id="insertFileMaster" parameterType="egovframework.com.approval.service.File">
			INSERT INTO COMTNFILE
			(ATCH_FILE_ID, CREAT_DT, USE_AT)
			VALUES
			( #{atchFileId}, SYSDATE, 'Y')			
		
	</insert>
	
	<insert id="insertFileDetail" parameterType="egovframework.com.approval.service.ApprovalParentDTO">
		
			INSERT INTO COMTNFILEDETAIL
			( ATCH_FILE_ID, FILE_SN, FILE_STRE_COURS, STRE_FILE_NM, 
			  ORIGNL_FILE_NM, FILE_EXTSN, FILE_SIZE, FILE_CN )
			VALUES
			( #{atchFileId}, #{fileSn}, #{fileStreCours}, #{streFileNm}, 
			  #{orignlFileNm}, #{fileExtsn}, #{fileMg}, #{fileCn} )			
		
	</insert>	
    
    
    <!-- 문서회수(상태 회수로변경) -->
    <update id="documentUpdate">
    	update document
    	set	crnt_sign_stat='H05'
    	where doc_cd = #{docCd}
    </update>
    
    <!-- 문서삭제 -->
     <update id="documentDelete">
    	update document
    	set	del_yn = 'Y'
    	where doc_cd = #{docCd}
    </update>
    
    <!-- 문서양식 -->
    <select id="formSelectAll" resultType = "egovframework.com.approval.service.FormDTO">
    	SELECT
    		form_cd,
    		form_type,
    		form_file
    	FROM FORM_TYPE
    </select>
    
    <!-- 문서카운트 -->
    <select id="getCount" resultType="int">
	  SELECT 
	  COUNT(*) 
	  FROM document
	  where 1=1
	  <include refid="searchCriteria" />
	</select>
	
    <!-- 문서조회 -->
    <select id="documentSelectAll" resultType="egovframework.com.approval.service.DocumentDTO" parameterType="egovframework.com.approval.service.SearchDTO">
		 SELECT * FROM (
		            SELECT 
		                ROWNUM AS rn,
		                doc_cd,
		                doc_title,
		                doc_cn_editor,
		                fn_get_memnm(mber_id) as mber_id,
		                fn_get_deptNm(mber_id) as dept_nm,
		                fn_get_codename(CRNT_SIGN_STAT) as crnt_sign_stat,
		                draft_dt,
		                complete_dt,
		                fn_get_codename(DOC_KIND) as doc_kind,
		                atch_file_id,
		                form_cd,
		                fn_get_formnm(form_cd) as form_nm,
		                del_yn
		            FROM DOCUMENT
		                WHERE 1=1
		                AND del_yn = UPPER('N')
		                <include refid="searchCriteria"/>
		            <![CDATA[AND ROWNUM <= #{end}]]>
		        ) 
		        WHERE rn >= #{start}
		        ORDER BY draft_dt DESC
    </select>

	<!-- 부서코드로 사원조회 -->
	  <select id="memberSelectAll" resultType="egovframework.com.approval.service.MemberDTO" parameterType="egovframework.com.approval.service.SearchDTO">
    	SELECT
    		mber_id,
    		mber_nm,
    		resp_cd,
    		dept_cd,
    		(select dept_nm from department where dept_cd = #{deptCd}) as dept_nm
    	FROM COMTNGNRLMBER
    	WHERE dept_cd = #{deptCd}
    </select>
	<!-- 검색조건함수 -->
    <sql id="searchCriteria">
        <if test="status != null and status != ''">
            AND crnt_sign_stat = #{status}
        </if>
        <if test="delYn != null and delYn != ''">
            AND del_yn = #{delYn}
        </if>
        <if test="formCd != null and formCd != ''">
            AND form_cd = #{formCd}
        </if>
		<if test="docKind != null and docKind != ''">
            AND doc_kind = #{docKind}
        </if>
        <if test="deptNm != null and deptNm != ''">
            AND fn_get_deptNm(mber_id) = #{deptNm}
        </if>
		<if test='!startDate.isEmpty()'>
			<![CDATA[
			and to_char(draft_dt, 'yyyy-mm-dd') >= #{startDate}
			]]>
		</if>
		<if test='!endDate.isEmpty()'>
			<![CDATA[
			and to_char(draft_dt, 'yyyy-mm-dd') <= #{endDate}
			]]>
		</if>
    </sql>
</mapper>